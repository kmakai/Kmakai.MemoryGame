@page "/"
@rendermode InteractiveWebAssembly


<div class="w-100 h-100 d-flex flex-column">
    <div class="top-row ps-3  navbar navbar-dark">
        <div class="@(!playing ? "hidden" : "")">
            @if (mode != GameMode.Moves)
            {
                <p class="">
                    Time: @elapsedTime.ToString(@"hh\:mm\:ss") @(TimeLimit > 0 ? $" / 00:0{TimeLimit}:00" : "")
                </p>
            }
            else
            {
                <p class="">
                    Moves: @moves
                </p>
            }

        </div>
    </div>
    @if (!playing || (cardDisplayList != null && IsGameOver()))
    {
        <div class="Menu border border-1 border-success rounded my-auto" style="">
            @if (mode == null)
            {
                <div class="gamemode">
                    <h1 class="text-center">Choose game mode</h1>
                    <div class="d-flex gap-2 w-100 justify-content-center">
                        <button class="btn btn-success d-flex flex-column justify-content-center align-items-center" style="width: 200px;height: 200px;" @onclick="() => mode = GameMode.Normal">
                            <h3>
                                Normal
                            </h3>
                            <p>
                                <small>See how long it takes to finish the game</small>
                            </p>
                        </button>
                        <button class="btn btn-success d-flex flex-column justify-content-center align-items-center" style="width: 200px;height: 200px;" @onclick="() => mode = GameMode.RaceTime">
                            <h3>
                                Race Time
                            </h3>
                            <p>
                                <small>Get the highest score in the given time</small>
                            </p>
                        </button>
                        <button class="btn btn-success d-flex flex-column justify-content-center align-items-center" style="width: 200px;height: 200px;" @onclick="() => mode = GameMode.Moves">
                            <h3>
                                Moves
                            </h3>
                            <p>
                                <small>Get as many matches in the amount of moves given</small>
                            </p>
                        </button>
                    </div>
                </div>
            }

            @if (mode != null && difficulty != null)
            {
                <button class="btn btn-success fs-3 d-flex justify-content-center align-items-center mx-auto" style="width: 200px;height: 200px;" @onclick="() => StartGame()">Start game</button>
            }

            @if (mode != null && difficulty == null)
            {
                <div class="gamedifficulty">
                    <h1 class="text-center">Choose game difficulty</h1>
                    <div class="d-flex gap-2 w-100 justify-content-center">
                        <button class="btn btn-success d-flex flex-column justify-content-center align-items-center" style="width: 200px;height: 200px;" @onclick="() => difficulty = GameDifficulty.Easy">
                            <h3>
                                Easy
                            </h3>
                            <p>
                                match 8 pairs of cards
                            </p>
                            @if (mode == GameMode.RaceTime)
                            {
                                <p>
                                    <small>Time limit: 1 minutes</small>
                                </p>
                            }
                            @if (mode == GameMode.Moves)
                            {
                                <p>
                                    <small>Moves limit: 16</small>
                                </p>
                            }
                        </button>
                        <button class="btn btn-success d-flex flex-column justify-content-center align-items-center" style="width: 200px;height: 200px;" @onclick="() => difficulty = GameDifficulty.Normal">
                            <h3>
                                Normal
                            </h3>
                            <p>
                                Match 12 pairs of cards
                            </p>
                            @if (mode == GameMode.RaceTime)
                            {
                                <p>
                                    <small>Time limit: 2 minute</small>
                                </p>
                            }
                            @if (mode == GameMode.Moves)
                            {
                                <p>
                                    <small>Moves limit: 24</small>
                                </p>
                            }
                        </button>
                        <button class="btn btn-success d-flex flex-column justify-content-center align-items-center" style="width: 200px;height: 200px;" @onclick="() => difficulty = GameDifficulty.Hard">
                            <h3>
                                Hard
                            </h3>
                            <p>
                                Match 16 pairs of cards
                            </p>
                            @if (mode == GameMode.RaceTime)
                            {
                                <p>
                                    <small>Time limit: 3 minutes</small>
                                </p>
                            }
                            @if (mode == GameMode.Moves)
                            {
                                <p>
                                    <small>Moves limit: 32</small>
                                </p>
                            }
                        </button>
                    </div>
                </div>
            }
        </div>
    }

    @if (cardDisplayList != null && IsGameOver())
    {

        <h2>Game Over</h2>
    }

    @if (cardDisplayList != null && playing && !IsGameOver())
    {
        <div class="d-flex flex-wrap gap-2 w-100 justify-content-center">
            @foreach (var card in cardDisplayList)
            {
                <button class="p-0 rounded-3 border border-0" style="width:125px;height:175px;" @onclick="() =>{ if(firstCard == null || secondCard == null ) FlipCard(card);}">
                    <img src="@(card.IsFlipped || card.IsMatched?@card.Image : "images/seal.png")" alt="@card.Name" class="w-100 h-100 m-0 rounded-2" />
                </button>

            }
        </div>
    }

</div>



@code {

    private bool playing = false;
    private Card[]? cardDisplayList;

    // testing
    private GameMode? mode;
    private GameDifficulty? difficulty;
    private Timer? timer;

    private void StartGame()
    {
        if (mode == GameMode.RaceTime) SetTimeLimit();
        timer = new Timer(NormalModeCallback!);
        if (mode == GameMode.Normal || mode == GameMode.RaceTime) timer.start();
        if (mode == GameMode.Moves) SetMoves();
        var cardsList = CardList.GetRandomCards(GameDifficultyExtensions.GetCardsNumber(difficulty ?? GameDifficulty.Normal));
        cardDisplayList = new Card[cardsList.Count * 2];
        int i = 0;
        foreach (var card in cardsList)
        {
            cardDisplayList[i] = new Card()
                {
                    Image = card.Image,
                    Name = card.Name,
                    IsFlipped = card.IsFlipped,
                    IsMatched = card.IsMatched
                };
            cardDisplayList[i + 1] = new Card()
                {
                    Image = card.Image,
                    Name = card.Name,
                    IsFlipped = card.IsFlipped,
                    IsMatched = card.IsMatched
                };

            i += 2;
        }

        ShuffleCards();

        playing = true;


    }

    private TimeSpan elapsedTime;
    public void NormalModeCallback(object state)
    {
        elapsedTime = DateTime.Now - timer!.StartTime;
        StateHasChanged();
        if (mode != GameMode.Moves || IsGameOver())
        {
            timer!.stop();
        }
    }

    private int TimeLimit = 0;
    private void SetTimeLimit()
    {
        switch (difficulty)
        {
            case GameDifficulty.Easy:
                TimeLimit = 1;
                break;
            case GameDifficulty.Normal:
                TimeLimit = 2;
                break;
            case GameDifficulty.Hard:
                TimeLimit = 3;
                break;
            default:
                TimeLimit = 0;
                break;
        }
    }

    private int moves = 0;
    private void SetMoves()
    {
        switch (difficulty)
        {
            case GameDifficulty.Easy:
                moves = 16;
                break;
            case GameDifficulty.Normal:
                moves = 24;
                break;
            case GameDifficulty.Hard:
                moves = 32;
                break;
            default:
                moves = 0;
                break;
        }
    }



    private void ShuffleCards()
    {
        Random rng = new Random();
        int n = cardDisplayList!.Length;
        while (n > 1)
        {
            n--;
            int k = rng.Next(n + 1);
            var value = cardDisplayList[k];
            cardDisplayList[k] = cardDisplayList[n];
            cardDisplayList[n] = value;
        }
    }

    private Card? firstCard = null;
    private Card? secondCard = null;
    private void FlipCard(Card card)
    {
        if (card.IsMatched || IsGameOver()) return;


        card.IsFlipped = true;

        if (firstCard == null) firstCard = card;
        else if (secondCard == null) secondCard = card;

        if (firstCard != null && secondCard != null) CheckMatch();

        if (IsGameOver() && mode != GameMode.Moves)
        {
            timer!.stop();
            Console.WriteLine($"Game Over - Your time is: {elapsedTime}");
        }

    }

    private async void CheckMatch()
    {
        Console.WriteLine("Checking Match");
        if (firstCard!.Name == secondCard!.Name)
        {
            firstCard.IsMatched = true;
            secondCard.IsMatched = true;
        }
        else
        {
            await Task.Delay(1000);
            firstCard.IsFlipped = false;
            secondCard.IsFlipped = false;
        }

        if (mode == GameMode.Moves) moves--;

        firstCard = null;
        secondCard = null;
        StateHasChanged();
    }



    private bool IsGameOver()
    {
        // cardDisplayList!.All(x => x.IsMatched) || elapsedTime.TotalMinutes >= TimeLimit;
        switch (mode)
        {
            case GameMode.Normal:
                return cardDisplayList!.All(x => x.IsMatched);
            case GameMode.RaceTime:
                return elapsedTime.TotalMinutes >= TimeLimit || cardDisplayList!.All(x => x.IsMatched);
            case GameMode.Moves:
                return moves <= 0 || cardDisplayList!.All(x => x.IsMatched);
            default:
                return false;
        };
    }

}
